<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veterinaria Municipal - Sistema de Atenci√≥n Veterinaria</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üè•</text></svg>">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}?v=2.1">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>
<body>
    <!-- BOT√ìN HAMBURGUESA M√ìVIL -->
    <button class="menu-toggle" onclick="toggleMenu()" aria-label="Abrir men√∫">
        <span></span>
        <span></span>
        <span></span>
    </button>

    <!-- OVERLAY PARA CERRAR MEN√ö -->
    <div class="menu-overlay" onclick="toggleMenu()"></div>

    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <h1>üè• Veterinaria Municipal</h1>
            <p>Gualeguaych√∫, ER</p>
        </div>

        <nav class="sidebar-nav">
            <a href="#" class="nav-item active" data-section="dashboard">
                <span class="nav-icon">üìä</span>
                <span>Dashboard</span>
            </a>
            <a href="#" class="nav-item" data-section="registro">
                <span class="nav-icon">‚ûï</span>
                <span>Nueva Atenci√≥n</span>
            </a>
            <a href="#" class="nav-item" data-section="busqueda">
                <span class="nav-icon">üîç</span>
                <span>B√∫squeda</span>
            </a>
            <a href="#" class="nav-item" data-section="estadisticas">
                <span class="nav-icon">üìà</span>
                <span>Estad√≠sticas</span>
            </a>
            <a href="#" class="nav-item" data-section="mapa">
                <span class="nav-icon">üó∫Ô∏è</span>
                <span>Mapa</span>
            </a>
            <a href="#" class="nav-item" data-section="turnos">
                <span class="nav-icon">üìÖ</span>
                <span>Agenda</span>
            </a>
            <a href="#" class="nav-item" data-section="auditoria">
                <span class="nav-icon">üìã</span>
                <span>Historial</span>
            </a>
        </nav>

        <div class="sidebar-footer">
            <div class="user-info">
                <div class="user-avatar">MT</div>
                <div class="user-details">
                    <div class="user-name">{{ usuario }}</div>
                    <div class="user-role">Administrativa</div>
                </div>
            </div>
            <button onclick="logout()" class="btn-logout">Cerrar Sesi√≥n</button>
            
            <div class="developer-credit">
                <small>Realizado por: <strong>Lisandro M. Etcheverry</strong></small>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        <div class="topbar">
            <div class="topbar-left">
                <h2 id="section-title">Dashboard</h2>
                <p id="section-subtitle">Vista general del sistema</p>
            </div>
            <div class="topbar-right">
                <button onclick="exportarExcel()" class="btn-export">
                    <span>üì•</span> Exportar Excel
                </button>
                <div class="datetime" id="current-datetime"></div>
            </div>
        </div>

        <!-- DASHBOARD SECTION -->
        <section id="dashboard" class="content-section active">
            <div class="metrics-grid">
                <div class="metric-card primary">
                    <div class="metric-icon">üè•</div>
                    <div class="metric-content">
                        <div class="metric-label">Atenciones Hoy</div>
                        <div class="metric-value" id="metric-hoy">0</div>
                    </div>
                </div>

                <div class="metric-card success">
                    <div class="metric-icon">üìÖ</div>
                    <div class="metric-content">
                        <div class="metric-label">Esta Semana</div>
                        <div class="metric-value" id="metric-semana">0</div>
                    </div>
                </div>

                <div class="metric-card info">
                    <div class="metric-icon">üìÜ</div>
                    <div class="metric-content">
                        <div class="metric-label">Este Mes</div>
                        <div class="metric-value" id="metric-mes">0</div>
                    </div>
                </div>

                <div class="metric-card warning">
                    <div class="metric-icon">ü©∫</div>
                    <div class="metric-content">
                        <div class="metric-label">Atenci√≥n Primaria Hoy</div>
                        <div class="metric-value" id="metric-primaria">0</div>
                    </div>
                </div>
            </div>

            <div class="dashboard-grid">
                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>üìã Turnos de Hoy</h3>
                        <button onclick="mostrarFormularioTurno()" class="btn-sm btn-primary">+ Nuevo Turno</button>
                    </div>
                    <div class="card-body" id="turnos-hoy-container">
                        <div class="loading-spinner"></div>
                    </div>
                </div>

                <div class="dashboard-card">
                    <div class="card-header">
                        <h3>üïí √öltimas Atenciones</h3>
                    </div>
                    <div class="card-body" id="ultimas-atenciones-container">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>

            <div class="dashboard-card full-width">
                <div class="card-header">
                    <h3>üìÖ Cronograma Semanal</h3>
                </div>
                <div class="card-body" id="cronograma-container">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </section>

        <!-- REGISTRO SECTION -->
        <section id="registro" class="content-section">
            <div class="form-card">
                <div class="form-header">
                    <h3>Nueva Atenci√≥n Veterinaria</h3>
                    <p>Complete los datos del animal y tutor</p>
                </div>

                <form id="form-atencion" class="modern-form">
                    <div class="form-section">
                        <h4>Tipo de Atenci√≥n</h4>
                        <div class="tipo-atencion-selector">
                            <label class="tipo-option active">
                                <input type="radio" name="tipo_atencion" id="tipo-atencion" value="castracion" checked>
                                <div class="option-content">
                                    <span class="option-icon">‚úÇÔ∏è</span>
                                    <span class="option-label">Castraci√≥n</span>
                                </div>
                            </label>
                            <label class="tipo-option">
                                <input type="radio" name="tipo_atencion" value="atencion_primaria">
                                <div class="option-content">
                                    <span class="option-icon">ü©∫</span>
                                    <span class="option-label">Atenci√≥n Primaria</span>
                                </div>
                            </label>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>Datos del Animal</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>N√∫mero de Registro*</label>
                                <input type="number" name="numero" id="numero" required>
                            </div>
                            <div class="form-group">
                                <label>Fecha*</label>
                                <input type="date" name="fecha" id="fecha" required>
                            </div>
                            <div class="form-group">
                                <label>Nombre del Animal*</label>
                                <input type="text" name="nombre_animal" id="nombre-animal" required>
                            </div>
                            <div class="form-group">
                                <label>Especie*</label>
                                <select name="especie" id="especie" required>
                                    <option value="">Seleccione...</option>
                                    <option value="Canino">Canino</option>
                                    <option value="Felino">Felino</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Sexo*</label>
                                <select name="sexo" id="sexo" required>
                                    <option value="">Seleccione...</option>
                                    <option value="Macho">Macho</option>
                                    <option value="Hembra">Hembra</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Edad Aproximada</label>
                                <input type="text" name="edad" id="edad" placeholder="Ej: 2 a√±os, 6 meses">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>Datos del Tutor</h4>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nombre y Apellido*</label>
                                <input type="text" name="nombre_apellido" id="nombre-apellido" required>
                            </div>
                            <div class="form-group">
                                <label>DNI*</label>
                                <input type="text" name="dni" id="dni" required>
                            </div>
                            <div class="form-group">
                                <label>Tel√©fono</label>
                                <input type="text" name="telefono" id="telefono" placeholder="3446-XXXXXX">
                            </div>
                            <div class="form-group">
                                <label>Direcci√≥n</label>
                                <input type="text" name="direccion" id="direccion" placeholder="Calle y n√∫mero">
                            </div>
                            <div class="form-group">
                                <label>Barrio</label>
                                <input type="text" name="barrio" id="barrio" list="barrios-list">
                                <datalist id="barrios-list">
                                    <option value="Centro">
                                    <option value="Pueblo Nuevo">
                                    <option value="Barrio Parque">
                                    <option value="Pueblo Belgrano">
                                    <option value="Villa Elisa">
                                    <option value="Larralde">
                                    <option value="San Jos√©">
                                </datalist>
                            </div>
                        </div>
                    </div>

                    <!-- CAMPOS ESPEC√çFICOS ATENCI√ìN PRIMARIA -->
                    <div class="form-section" id="section-atencion-primaria" style="display: none;">
                        <h4>Detalles de Atenci√≥n Primaria</h4>
                        <div class="form-grid">
                            <div class="form-group full-width">
                                <label>Motivo de Consulta*</label>
                                <textarea name="motivo" id="motivo" rows="2" placeholder="Ej: Retiro de puntos, Control post-operatorio, Consulta general"></textarea>
                            </div>
                            <div class="form-group full-width">
                                <label>Diagn√≥stico</label>
                                <textarea name="diagnostico" id="diagnostico" rows="2" placeholder="Diagn√≥stico o evaluaci√≥n del veterinario"></textarea>
                            </div>
                            <div class="form-group full-width">
                                <label>Tratamiento Aplicado</label>
                                <textarea name="tratamiento" id="tratamiento" rows="2" placeholder="Medicaci√≥n, procedimientos realizados"></textarea>
                            </div>
                            <div class="form-group full-width">
                                <label>Derivaci√≥n</label>
                                <input type="text" name="derivacion" id="derivacion" placeholder="Hospital, especialista, etc. (si aplica)">
                            </div>
                        </div>
                    </div>

                    <div class="form-section">
                        <h4>Observaciones Adicionales</h4>
                        <div class="form-group">
                            <textarea name="observaciones" id="observaciones" rows="3" placeholder="Cualquier informaci√≥n adicional relevante"></textarea>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="button" onclick="limpiarFormulario()" class="btn btn-secondary">Limpiar</button>
                        <button type="submit" class="btn btn-primary">Registrar Atenci√≥n</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- B√öSQUEDA SECTION -->
        <section id="busqueda" class="content-section">
            <div class="search-card">
                <div class="card-header">
                    <h3>üîç B√∫squeda de Atenciones</h3>
                </div>
                <div class="card-body">
                    <div class="search-filters">
                        <input type="number" id="search-numero" placeholder="N√∫mero de registro">
                        <select id="search-tipo">
                            <option value="">Todos los tipos</option>
                            <option value="castracion">Castraciones</option>
                            <option value="atencion_primaria">Atenci√≥n Primaria</option>
                        </select>
                        <select id="search-especie">
                            <option value="">Todas las especies</option>
                            <option value="Canino">Caninos</option>
                            <option value="Felino">Felinos</option>
                        </select>
                        <input type="text" id="search-dni" placeholder="DNI del tutor">
                        <input type="text" id="search-barrio" placeholder="Barrio">
                        <input type="date" id="search-fecha-desde">
                        <input type="date" id="search-fecha-hasta">
                        <button onclick="buscarAtenciones()" class="btn btn-primary">Buscar</button>
                    </div>
                    <div id="resultados-busqueda" class="results-container"></div>
                </div>
            </div>
        </section>

        <!-- ESTAD√çSTICAS SECTION -->
        <section id="estadisticas" class="content-section">
            <div class="stats-header">
                <h3>üìä Estad√≠sticas y Reportes</h3>
                <div class="stats-filters">
                    <input type="date" id="stats-fecha-desde">
                    <input type="date" id="stats-fecha-hasta">
                    <button onclick="cargarEstadisticas()" class="btn btn-primary">Actualizar</button>
                </div>
            </div>

            <!-- TOTALES EN TEXTO -->
            <div class="stats-totals">
                <div class="total-card">
                    <div class="total-icon">üìã</div>
                    <div class="total-content">
                        <div class="total-label">Total Atenciones</div>
                        <div class="total-value" id="total-atenciones">0</div>
                    </div>
                </div>
                <div class="total-card">
                    <div class="total-icon">‚úÇÔ∏è</div>
                    <div class="total-content">
                        <div class="total-label">Castraciones</div>
                        <div class="total-value" id="total-castraciones">0</div>
                    </div>
                </div>
                <div class="total-card">
                    <div class="total-icon">ü©∫</div>
                    <div class="total-content">
                        <div class="total-label">Atenci√≥n Primaria</div>
                        <div class="total-value" id="total-atencion-primaria">0</div>
                    </div>
                </div>
                <div class="total-card">
                    <div class="total-icon">üêï</div>
                    <div class="total-content">
                        <div class="total-label">Caninos</div>
                        <div class="total-value" id="total-caninos">0</div>
                    </div>
                </div>
                <div class="total-card">
                    <div class="total-icon">üêà</div>
                    <div class="total-content">
                        <div class="total-label">Felinos</div>
                        <div class="total-value" id="total-felinos">0</div>
                    </div>
                </div>
                <div class="total-card">
                    <div class="total-icon">‚ôÄÔ∏è</div>
                    <div class="total-content">
                        <div class="total-label">Hembras</div>
                        <div class="total-value" id="total-hembras">0</div>
                    </div>
                </div>
                <div class="total-card">
                    <div class="total-icon">‚ôÇÔ∏è</div>
                    <div class="total-content">
                        <div class="total-label">Machos</div>
                        <div class="total-value" id="total-machos">0</div>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <h4>Por Tipo de Atenci√≥n</h4>
                    <p id="stats-tipo-texto" class="stats-summary"></p>
                    <canvas id="chart-tipo"></canvas>
                </div>
                <div class="stat-card">
                    <h4>Por Especie</h4>
                    <p id="stats-especie-texto" class="stats-summary"></p>
                    <canvas id="chart-especie"></canvas>
                </div>
                <div class="stat-card">
                    <h4>Por Sexo</h4>
                    <p id="stats-sexo-texto" class="stats-summary"></p>
                    <canvas id="chart-sexo"></canvas>
                </div>
                <div class="stat-card full-width">
                    <h4>Tendencia Mensual</h4>
                    <p id="stats-temporal-texto" class="stats-summary"></p>
                    <canvas id="chart-temporal"></canvas>
                </div>
                <div class="stat-card full-width">
                    <h4>Top 10 Barrios</h4>
                    <p id="stats-barrio-texto" class="stats-summary"></p>
                    <canvas id="chart-barrios"></canvas>
                </div>
            </div>
        </section>

        <!-- MAPA SECTION -->
        <section id="mapa" class="content-section">
            <div class="map-card">
                <div class="card-header">
                    <div>
                        <h3>üó∫Ô∏è Mapa de Castraciones por Barrio</h3>
                        <p class="card-subtitle">Visualizaci√≥n geogr√°fica de cobertura en Gualeguaych√∫</p>
                    </div>
                    <button onclick="cargarMapa()" class="btn btn-primary">üîÑ Actualizar</button>
                </div>
                <div class="map-container">
                    <div id="map"></div>
                    <div class="map-legend">
                        <h4>üìç Leyenda</h4>
                        <div class="legend-item">
                            <span class="legend-circle" style="background: rgba(255, 107, 107, 0.6);"></span>
                            <span>Alta cobertura (30+ castraciones)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-circle" style="background: rgba(255, 160, 122, 0.6);"></span>
                            <span>Cobertura media (10-29)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-circle" style="background: rgba(78, 205, 196, 0.6);"></span>
                            <span>Baja cobertura (1-9)</span>
                        </div>
                        <div class="legend-item">
                            <span class="legend-circle" style="background: rgba(200, 200, 200, 0.4); border: 2px dashed #999;"></span>
                            <span>Sin castraciones registradas</span>
                        </div>
                        <p class="legend-note">üí° Tama√±o del c√≠rculo = cantidad de castraciones</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- TURNOS SECTION -->
        <section id="turnos" class="content-section">
            <div class="turnos-card">
                <div class="card-header">
                    <h3>üìÖ Gesti√≥n de Agenda y Turnos</h3>
                    <button onclick="mostrarFormularioTurno()" class="btn btn-primary">+ Nuevo Turno</button>
                </div>
                <div class="card-body" id="lista-turnos">
                    <div class="loading-spinner"></div>
                </div>
            </div>
        </section>

        <!-- AUDITORIA SECTION -->
        <section id="auditoria" class="content-section">
            <div class="auditoria-card">
                <div class="card-header">
                    <h3>üìã Historial de Cambios (Auditor√≠a)</h3>
                    <button onclick="cargarAuditoria()" class="btn btn-primary">üîÑ Actualizar</button>
                </div>
                <div class="card-body">
                    <p class="info-text">Registro completo de todas las eliminaciones y modificaciones realizadas en el sistema.</p>
                    <div id="tabla-auditoria">
                        <div class="loading-spinner"></div>
                    </div>
                </div>
            </div>
        </section>
    </div>

    <!-- MODAL TURNO -->
    <div class="modal" id="modal-turno">
        <div class="modal-overlay" onclick="cerrarModalTurno()"></div>
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Turno</h3>
                <button class="modal-close" onclick="cerrarModalTurno()">√ó</button>
            </div>
            <form id="form-turno" class="modal-body">
                <div class="form-group">
                    <label>Fecha*</label>
                    <input type="date" name="fecha" required>
                </div>
                <div class="form-group">
                    <label>Hora*</label>
                    <input type="time" name="hora" required>
                </div>
                <div class="form-group">
                    <label>Nombre del Animal*</label>
                    <input type="text" name="nombre_animal" required>
                </div>
                <div class="form-group">
                    <label>Nombre del Tutor*</label>
                    <input type="text" name="tutor_nombre" required>
                </div>
                <div class="form-group">
                    <label>Tel√©fono</label>
                    <input type="text" name="telefono" placeholder="3446-XXXXXX">
                </div>
                <div class="form-group">
                    <label>Tipo de Turno*</label>
                    <select name="tipo" required>
                        <option value="Castraci√≥n">Castraci√≥n</option>
                        <option value="Retiro de puntos">Retiro de puntos</option>
                        <option value="Control">Control post-operatorio</option>
                        <option value="Consulta">Consulta general</option>
                        <option value="Vacunaci√≥n">Vacunaci√≥n</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Observaciones</label>
                    <textarea name="observaciones" rows="2"></textarea>
                </div>
            </form>
            <div class="modal-footer">
                <button type="button" onclick="cerrarModalTurno()" class="btn btn-secondary">Cancelar</button>
                <button type="submit" form="form-turno" class="btn btn-primary">Guardar Turno</button>
            </div>
        </div>
    </div>

    <!-- NOTIFICATION -->
    <div id="notification" class="notification"></div>

        <script src="{{ url_for('static', filename='script.js') }}?v=3.1"></script>
</body>
</html>
